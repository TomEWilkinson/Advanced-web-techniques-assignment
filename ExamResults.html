
 <!DOCTYPE html>
 <html>
 <head>
 	<title>Edit Results</title>

 	<link rel="stylesheet" href="assets/timetablejs.css">
 	<link rel="stylesheet" href="assets/core.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
	<script src="assets/timetable.min.js"></script> 
	<script src="assets/moment.min.js"></script> 
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
	<script src="assets/main.js"></script>

 </head>
 <body>
	 <nav class="navbar navbar-default">
	    <div class="container-fluid">
	      <!-- Brand and toggle get grouped for better mobile display -->
	      <div class="navbar-header">
	        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	          <span class="sr-only">Toggle navigation</span>
	          <span class="icon-bar"></span>
	          <span class="icon-bar"></span>
	          <span class="icon-bar"></span>
	        </button>
	        <a class="navbar-brand" href="http://mudfoot.doc.stu.mmu.ac.uk/students/wilkinst/cw1/AccountHomepage.html">TimeTable App</a>
	      </div>

	      <!-- Collect the nav links, forms, and other content for toggling -->
	      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	        <ul class="nav navbar-nav">
	          <li class="my-timetable"><a href="#" return false;>My Timetable<span class="sr-only">(current)</span></a></li>
          	  <li><a class="Update-Details" href="http://mudfoot.doc.stu.mmu.ac.uk/students/wilkinst/cw1/UpdateDetails.html">Update Details</a></li>
          	  <li class="attendance-link"><a href="http://mudfoot.doc.stu.mmu.ac.uk/students/wilkinst/cw1/attendance.html" return false; >Attendance<span class="sr-only">(current)</span></a></li>
          	  <li class="edit-lessons"><a return false; style="display: none;" href="http://mudfoot.doc.stu.mmu.ac.uk/students/wilkinst/cw1/editLessons.html">Edit Lessons<span class="sr-only">(current)</span></a></li>
          	  <li class="exam-results active"><a return false; style="display: none;" href="#">Exam Results<span class="sr-only">(current)</span></a></li>
          	  <li class="analysis"><a return false; style="display: none;" href="http://mudfoot.doc.stu.mmu.ac.uk/students/wilkinst/cw1/analysis.html">Analysis<span class="sr-only">(current)</span></a></li>
          	  <li class="map-link"><a return false; style="display: none;" href="http://mudfoot.doc.stu.mmu.ac.uk/students/wilkinst/cw1/campusmap.html">Map<span class="sr-only">(current)</span></a></li>
	        </ul>
	        <ul class="nav navbar-nav navbar-right">
		       <li><a href="#" onClick="logOut()" return false;>logout</a></li>
		    </ul>
	      </div><!-- /.navbar-collapse -->
	    </div><!-- /.container-fluid -->
	  </nav>

    <div class="container">
		<label>Select A Lesson To View And Modify Exam Results</label>
		<select id="lesson-name" class="form-control" required><option>Please Select</option></select>

		<table id="mark-table" class="table table-striped"></table>
    	<br> <br>
		<div class="">
    		<button id="save-new-marks" type="submit" class="btn btn-primary pull-left">Save Result Changes</button>
    		<button id="save-new-exam" type="button" class="btn btn-primary pull-right" data-toggle="modal" data-target="#new-lesson-modal">Add New Results</button>
    	</div>
    	<br><br><br>
    	<div class="">
    		<label>Select a text file to upload:</label>
        	<input type="file" id="file-input">
        </div>

	</div>

	<div class="modal fade" id="new-lesson-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Add New Mark</h4>
				</div>
				<div class="modal-body">
					<form id="new-mark">
						<div class="form-group">
							<label>Student First Name</label>
						    <input id="student-first-name" type="text" class="form-control" placeholder="Text input" required>
						 </div>
						 <div class="form-group">
							<label>Student Second Name</label>
						    <input id="student-second-name" type="text" class="form-control" placeholder="Text input" required>
						 </div>
						 <div class="form-group">
						 	<label>lesson</label>
							<select id="lesson" class="form-control" required><option>Please Select</option></select>
						 </div>
						 <div class="form-group">
						 	<label>Mark</label>
						 	<input id="mark" type="number" class="form-control" placeholder="" required>
						 </div>
						 <div class="form-group">
    						<button type="submit" class="btn btn-primary pull-left">Save New Result</button>
    					</div>
					</form>
					<br><br>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="table-update-message" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Update Message</h4>
				</div>
				<div class="modal-body">
					<p id="update-message"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>



 </body>
 <script type="text/javascript">
 $(document).ready(function() {
    var user = JSON.parse(getCookie('user').replace(/\[|\]/g, ''));
 	getTimetableLink(user.is_staff);

 	var tableArray = [];

	$.ajax({
    type: "GET",
    url: '/students/wilkinst/cw1/LessonsTable.php',
    dataType:'json',
     success: function(data) {
     	var dropdown = "";
     	for (var key in data) { 
     		if(data[key].lesson != "Socrates Appointment")
     		{
     			dropdown = dropdown + "<option>" + data[key].lesson + "</option>";
     		}
     	}
     	$('#lesson-name').append(dropdown);
     	$('#lesson').append(dropdown);

      }
  	});

  	$( "#lesson-name" ).change(function() {
	  	GetDisplayData();	
	 });
	$( "#save-new-marks" ).click(function() {
		mark_array = [];
		var lessonName = $( "#lesson-name" ).val();
		$( ".student-row" ).each(function( index ) {
		   var student_name = $( this ).children('.student-name').text();
		   var student_id   = $( this ).children('.student-id').text();
		   var mark         = $( this ).children('.student-mark').text();

		   mark_array.push({
		   		student_name: student_name,
		   		student_id:   student_id,
		   		mark:         mark,
		   		lesson_name:  lessonName
		   })
		});
		var mark_json = JSON.stringify(mark_array);
		$.ajax({
			type: "POST",
			data: {
				update_array: mark_json
			},
			url: '/students/wilkinst/cw1/ExamResults.php',
			success: function(data) {
				$('#update-message').text(data);
				$('#table-update-message').modal('show');
			},

		});
	});

	$( "#new-mark" ).submit(function(event) {
		event.preventDefault();
		var student_first_name   = $('#student-first-name').val();
		var student_second_name  = $('#student-second-name').val();
		var mark                 = $('#mark').val();
		var lesson               = $('#lesson').val();

		$.ajax({
			type: "POST",
			data: {
				student_first_name: student_first_name,
				student_second_name: student_second_name,
				mark: mark,
				lesson: lesson
			},
			url: '/students/wilkinst/cw1/ExamResults.php',
			success: function(data) {
				$('#update-message').text(data);
				$('#table-update-message').modal('show');	
			},

		});
	});

	$("#file-input").change(function(){
        var fileVal=document.getElementById("file-input").files[0];
        if (fileVal) {
		    var reader = new FileReader();
		    reader.readAsText(fileVal, "UTF-8");
		    reader.onload = function (evt) {
		       processData(evt.target.result);
		    }
		    reader.onerror = function (evt) {
		        alert("error reading file");
		    }
		}

	 });

	var tableArray = [];

	$.get({
		url: '/students/wilkinst/cw1/AttendanceTable.php', 
		data: { }, 
		success: function(data) {
			data = JSON.parse(data);
			for (var i = 0; i < data.length; i++) {
				if (typeof tableArray[data[i].student_id] == 'undefined') {

					tableArray[data[i].student_id] = {[data[i].lesson] : parseInt(data[i].attendance), "student_name" : data[i].student_name, "student_id":  data[i].student_id};
					tableArray[data[i].student_id][[data[i].lesson] + "_total"] = 1;

				}
				else if(typeof tableArray[data[i].student_id][data[i].lesson] == 'undefined') {
					tableArray[data[i].student_id][data[i].lesson] = parseInt(data[i].attendance);
					tableArray[data[i].student_id][[data[i].lesson] + "_total"] = 1;
				}
				else {
					tableArray[data[i].student_id][data[i].lesson] =  parseInt(tableArray[data[i].student_id][data[i].lesson]) +  parseInt(data[i].attendance);
					tableArray[data[i].student_id][[data[i].lesson] + "_total"] = tableArray[data[i].student_id][[data[i].lesson + "_total"]] + 1;
				}


			}

		}
  });
 	
});

function GetDisplayData()
{
	var lessonName = $( "#lesson-name" ).val();
	var resultsArray = [];
	if(lessonName != "Please Select"){
		$.ajax({
			type: "POST",
			data: {
				lesson_name: lessonName,
			},
			url: '/students/wilkinst/cw1/ExamResults.php',
			dataType:'json',
			success: function(data) {
				ResultsTable(data);
				resultsArray = data;
			}
		});
		var tableArray = [];

		$.get({
			url: '/students/wilkinst/cw1/AttendanceTable.php', 
			data: { }, 
			success: function(data) {

				data = JSON.parse(data);
				for (var i = 0; i < data.length; i++) {
					if (typeof tableArray[data[i].student_id] == 'undefined') {

						tableArray[data[i].student_id] = {[data[i].lesson] : parseInt(data[i].attendance), "student_name" : data[i].student_name, "student_id":  data[i].student_id};
						tableArray[data[i].student_id][[data[i].lesson] + "_total"] = 1;

					}
					else if(typeof tableArray[data[i].student_id][data[i].lesson] == 'undefined') {
						tableArray[data[i].student_id][data[i].lesson] = parseInt(data[i].attendance);
						tableArray[data[i].student_id][[data[i].lesson] + "_total"] = 1;
					}
					else {
						tableArray[data[i].student_id][data[i].lesson] =  parseInt(tableArray[data[i].student_id][data[i].lesson]) +  parseInt(data[i].attendance);
						tableArray[data[i].student_id][[data[i].lesson] + "_total"] = tableArray[data[i].student_id][[data[i].lesson + "_total"]] + 1;
					}


				}
			}
		});

	}
}


function ResultsTable(data)
{
	$( "#mark-table > *" ).remove();
	table = "<thead> <tr> <th>Student Name</th> <th>Student ID</th> <th>Exam Result</th> </tr> </thead><tbody>";
	for (var key in data) { 
		table = table + "<tr class=\"student-row\"><td class=\"student-name\">" + data[key].student_name + "</td><td class=\"student-id\">" + data[key].student_id + "</td><td contenteditable='true' class=\"student-mark\">" + data[key].mark + "</td></tr>"
	}
	table = table + "</tbody>";
	$('#mark-table').append(table);
}

function processData(text) {
	var splitText = text.replace(/\r/g, "");
	splitText = splitText.split("\n");

	var insertArray = [];
	if(splitText[0].split(",").length == 3)
	{
		for (var key in splitText) {
			if(key != 0)
			{
				var temp = splitText[key].split(",");
				var obj = {mark: temp[0], student_id:temp[1],lesson_name:temp[2]};
				insertArray.push(obj);
			}
		}
		var postArray = JSON.stringify(insertArray);
		$.ajax({
				type: "POST",
				data: {
					post_array: postArray,
				},
				url: '/students/wilkinst/cw1/ExamResults.php',
				success: function(data) {
					$('#update-message').text(data);
					$('#table-update-message').modal('show')
				}
		});
	}
	else {
		$('#update-message').text("file not in the correct format");
		$('#table-update-message').modal('show');
	}


}

 </script>
 </html>